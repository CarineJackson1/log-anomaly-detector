name: Dependabot Security Scan

on:
  pull_request_target:
    branches: [develop, main]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  label-and-scan:
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ·ï¸ Apply labels
        uses: actions-ecosystem/action-add-labels@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          labels: |
            dependencies
            security-scan-required

      - name: ðŸ“¥ Checkout base code (safe)
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.base.ref }}

      - name: ðŸ“ Create reports directory
        run: mkdir -p security-reports/raw

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install Semgrep
        run: pip install semgrep

      - name: ðŸ” Run Semgrep Scan
        run: semgrep --config=auto --json --output=security-reports/raw/semgrep.json . || true

      - name: ðŸ“¤ Upload Semgrep report
        uses: actions/upload-artifact@v4
        with:
          name: dependabot-semgrep-report
          path: security-reports/raw/semgrep.json

      - name: ðŸ’¬ Post concise PR comment
        uses: actions/github-script@v7
        env:
          MAX_ISSUES: 10
        with:
          script: |
            const core = require('@actions/core');
            const fs = require('fs');
            const reportPath = 'security-reports/raw/semgrep.json';
            if (!fs.existsSync(reportPath)) {
              core.warning("No report found, skipping comment.");
              return;
            }
            const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
            const issues = report.results || [];
            const count = issues.length;
            const maxDisplay = parseInt(process.env.MAX_ISSUES, 10) || 10;
            const displayedIssues = issues.slice(0, maxDisplay)
              .map(i => `- ${i.extra?.message || "No message"} (Severity: ${i.extra?.severity || "N/A"})`)
              .join('\n');
            const summary = `## ðŸ” Dependabot Security Scan\nFound **${count}** potential issue(s).\n\nTop issues:\n${displayedIssues}${count > maxDisplay ? `\n...and ${count - maxDisplay} more.` : ''}\n\nFull details in the attached artifact.`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary,
            });
