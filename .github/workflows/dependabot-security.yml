name: Dependabot Security Scan

on:
  pull_request:
    branches: [develop, main]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  label-and-scan:
    # Temporarily disable actor check for testing
    # if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ·ï¸ Apply labels
        uses: actions-ecosystem/action-add-labels@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          labels: |
            dependencies
            security-scan-required

      - name: ğŸ“¥ Checkout base code (safe)
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.base.ref }}

      - name: ğŸ“ Create reports directory
        run: mkdir -p security-reports/raw

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install Semgrep
        run: pip install semgrep

      - name: ğŸ” Run Semgrep Scan
        run: semgrep --config=auto --json --output=security-reports/raw/semgrep.json . || true

      - name: ğŸ“¤ Upload Semgrep report
        uses: actions/upload-artifact@v4
        with:
          name: dependabot-semgrep-report
          path: security-reports/raw/semgrep.json

      - name: ğŸ’¬ Post concise PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = 'security-reports/raw/semgrep.json';
            if (!fs.existsSync(report)) {
              core.warning("No report found, skipping comment.");
              return;
            }
            const findings = JSON.parse(fs.readFileSync(report, 'utf8')).results.length;
            const summary = `## ğŸ” Dependabot Security Scan\nFound **${findings}** potential issues.\nFull details are in the attached artifact.`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary,
            });
