name: 🛡️ Semgrep Security Scan

on:
  push:
    branches:
      - main
      - develop
  pull_request:

jobs:
  semgrep-frontend:
    name: Semgrep Frontend Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write  # required for artifact uploads
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Semgrep
        run: pip install semgrep

      - name: Create report directory
        run: mkdir -p security-reports/raw

      - name: Run Semgrep (Frontend)
        run: |
          semgrep --config .github/semgrep/frontend-rules.yml frontend \
            --json > security-reports/raw/semgrep-frontend.json || true

      - name: Convert JSON to Markdown
        run: |
          echo "## Semgrep Frontend Report" > security-reports/semgrep-frontend.md
          jq -r '.results[] | "- **\(.check_id)** (\(.severity)) at \(.path):\(.start.line): \(.extra.message)"' security-reports/raw/semgrep-frontend.json >> security-reports/semgrep-frontend.md || echo "No findings."

      - name: Upload Artifacts (Frontend Reports)
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-frontend-reports
          path: |
            security-reports/raw/semgrep-frontend.json
            security-reports/semgrep-frontend.md

  semgrep-backend:
    name: Semgrep Backend Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Semgrep
        run: pip install semgrep

      - name: Create report directory
        run: mkdir -p security-reports/raw

      - name: Run Semgrep (Backend)
        run: |
          semgrep --config .github/semgrep/backend-rules.yml backend \
            --json > security-reports/raw/semgrep-backend.json || true

      - name: Convert JSON to Markdown
        run: |
          echo "## Semgrep Backend Report" > security-reports/semgrep-backend.md
          jq -r '.results[] | "- **\(.check_id)** (\(.severity)) at \(.path):\(.start.line): \(.extra.message)"' security-reports/raw/semgrep-backend.json >> security-reports/semgrep-backend.md || echo "No findings."

      - name: Upload Artifacts (Backend Reports)
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-backend-reports
          path: |
            security-reports/raw/semgrep-backend.json
            security-reports/semgrep-backend.md
