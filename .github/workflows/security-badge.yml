name: ðŸ”¹ Generate Dynamic Security Badge

# Trigger this workflow *after* the main scan workflow finishes successfully
on:
  workflow_run:
    workflows: ["Full Security Scan Pipeline"]  # exact name of your main scan workflow
    types:
      - completed

jobs:
  generate-badge:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write  # needed to commit badge JSON

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Read and parse security summary report
        id: parse
        run: |
          SUMMARY_FILE="security-reports/summary_report.md"

          if [[ ! -f "$SUMMARY_FILE" ]]; then
            echo "Security summary report not found!"
            echo "badge_color=red" >> $GITHUB_OUTPUT
            echo "label=missing" >> $GITHUB_OUTPUT
            echo "message=No+Report" >> $GITHUB_OUTPUT
            exit 0
          fi

          HIGH_COUNT=$(grep -ic 'severity: high' "$SUMMARY_FILE" || echo 0)
          if [[ $HIGH_COUNT -gt 0 ]]; then
            COLOR="red"
            MESSAGE="${HIGH_COUNT}+High+Issues"
          else
            COLOR="brightgreen"
            MESSAGE="No+High+Issues"
          fi

          echo "badge_color=$COLOR" >> $GITHUB_OUTPUT
          echo "label=security" >> $GITHUB_OUTPUT
          echo "message=$MESSAGE" >> $GITHUB_OUTPUT

      - name: Create Shields.io badge JSON
        run: |
          mkdir -p .github/badges
          cat <<EOF > .github/badges/security-badge.json
          {
            "schemaVersion": 1,
            "label": "${{ steps.parse.outputs.label }}",
            "message": "${{ steps.parse.outputs.message }}",
            "color": "${{ steps.parse.outputs.badge_color }}"
          }
          EOF

      - name: Commit & push badge JSON
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .github/badges/security-badge.json
          git commit -m "âœ¨ Update dynamic security badge" || echo "No changes to commit"
          git push
